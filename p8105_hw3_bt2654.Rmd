---
title: "p8105_hw3_bt2654"
author: "Boxiang Tang"
date: "2024-10-11"
output:
  github_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 1

```{r}
# Import & Load the data
library(p8105.datasets)
data("ny_noaa")

```


```{r}
# Initial data explorations
library(tidyverse)

glimpse(ny_noaa)
summary(ny_noaa)

# Convert tmin & tmax to numeric variables
ny_noaa =
  ny_noaa |>
  mutate(
    tmin = as.numeric(tmin),
    tmax = as.numeric(tmax)
  )
```


### Description of Raw Data:

The dataset contains `r nrow(ny_noaa)` observations and `r ncol(ny_noaa)` variables. Below are the key details:


* **Key Variables:**
  
  
  * date (numeric): Dates range from `r min(ny_noaa$date, na.rm = TRUE)` to `r max(ny_noaa$date, na.rm = TRUE)`, spanning `r as.numeric(difftime(max(ny_noaa$date, na.rm = TRUE), min(ny_noaa$date, na.rm = TRUE), units = "days"))` days.

  * prcp (numeric): Precipitation (tenths of mm), ranging from `r min(ny_noaa$prcp, na.rm = TRUE)` to `r max(ny_noaa$prcp, na.rm = TRUE)` with an average of `r mean(ny_noaa$prcp, na.rm = TRUE)`.
  
  * snow (numeric): Snowfall amount (mm), with an average of `r mean(ny_noaa$snow, na.rm = TRUE)` and a maximum of `r max(ny_noaa$snow, na.rm = TRUE)`.

  * snwd (numeric): Snow depth (mm), ranging from `r min(ny_noaa$snwd, na.rm = TRUE)` to `r max(ny_noaa$snwd, na.rm = TRUE)`.

  * tmax (character -> numeric): Maximum temperature (tenths of degrees Celsius), averaging `r mean(ny_noaa$tmax, na.rm = TRUE)` degrees Celsius.

  * tmin (character -> numeric): Minimum temperature (tenths of degrees Celsius), with an average of `r mean(ny_noaa$tmin, na.rm = TRUE)` degrees Celsius.
  

```{r}
# Analysising Missing Values of the raw data

missing_data_summary = 
  ny_noaa |>
  summarise(across(everything(), 
                   ~ sum(is.na(.))))


missing_data_percentage = 
  missing_data_summary / nrow(ny_noaa) * 100

missing_data_summary
missing_data_percentage

```


### Data about the missing values for the key variables:

* prcp : `r missing_data_summary$prcp` missing values (`r round(missing_data_percentage$prcp, 2)`% of the total dataset)

* snow : `r missing_data_summary$snow` missing values (`r round(missing_data_percentage$snow, 2)`%)

* snwd: `r missing_data_summary$snwd` missing values (`r round(missing_data_percentage$snwd, 2)`%)

* tmax: `r missing_data_summary$tmax` missing values (`r round(missing_data_percentage$tmax, 2)`%)

* tmin: `r missing_data_summary$tmin` missing values (`r round(missing_data_percentage$tmin, 2)`%)


### Indication of Missing Data Extent:

* The missing data percentage ranges significantly across variables. prcp has the least amount of missing data (5.62%), which is relatively low and unlikely to affect overall precipitation analysis significantly. However, imputation or removing these rows could be considered depending on the specific analysis.

* For snow, the missing data is approximately 14.69%, which is more substantial. Missing snowfall data could limit the ability to analyze snowfall patterns accurately, particularly for locations or periods where snow might be expected.
snwd has about 22.8% missing data. This level indicates that snow depth information might be inconsistent, and analyses relying on snow accumulation may be biased or less reliable without appropriate imputation methods.

* The most critical concern is with tmax and tmin, both of which have approximately 43.71% missing values. Such a high percentage implies that temperature data is nearly absent for almost half of the dataset. This poses a major limitation for any temperature-related analysis, such as identifying seasonal trends or calculating average temperatures. Given this extent of missing data, imputation techniques (like interpolation based on nearby stations) or focusing analyses on stations with more complete data might be necessary. In some cases, entire segments of the dataset might need to be excluded if temperature analysis is central to the study.

* **Summary:** The extent of missing data varies, with some variables (like prcp) showing manageable levels of missingness, while others (especially tmax and tmin) present significant issues. For temperature data, the missing rate of nearly 44% indicates a serious data quality issue, requiring careful handling to avoid biased or incomplete analysis outcomes


```{r}
# Data cleaning methods

# 1. Convert the date column to Date type and extract year, month, and day
ny_noaa =
  ny_noaa |>
  mutate(
    date = as.Date(date),
    year = as.integer(format(date, "%Y")),
    month = as.integer(format(date, "%m")),
    day = as.integer(format(date, "%d"))
  )


# 2. Convert temperature and precipitation to proper units
ny_noaa =
  ny_noaa |>
  mutate(
    prcp = prcp / 10,  # Convert precipitation to mm
    tmax = tmax / 10,  # Convert to degrees Celsius
    tmin = tmin / 10   # Convert to degrees Celsius
  )

# 3. Identify most commonly observed snowfall values
snowfall_distribution = 
  ny_noaa |>
  filter(!is.na(snow)) |>
  count(snow, sort = TRUE)

head(snowfall_distribution, 5)


```

### Important information from the manipulated data:

* Average precipitation: `r mean(ny_noaa$prcp, na.rm = TRUE)` mm, with a standard deviation of `r sd(ny_noaa$prcp, na.rm = TRUE)`.

* Average maximum temperature (tmax): `r mean(ny_noaa$tmax, na.rm = TRUE)` °C.

* Average minimum temperature (tmin): `r mean(ny_noaa$tmin, na.rm = TRUE)` °C.

* The most frequently recorded snowfall value is 0 mm, which occurs `r snowfall_distribution$n[1]` times, indicating no snowfall on most recorded days. The possible reasons for that could be following:
  
     * **Nature of the Dataset (GHCN-Daily):** The Global Historical Climatology Network-Daily (GHCN-Daily) database is structured to record daily weather statistics. In climates like New York's, it is expected that a large proportion of daily observations would have no snowfall, as even in winter months, many days do not receive measurable snow. Thus, the design and recording frequency of the dataset contribute to a higher frequency of zero values.
  
    * **Seasonality and Climate of New York State:**  New York experiences distinct seasonal changes. Snowfall typically occurs during the winter months (December through February), with possible snowfall events extending into late autumn (November) and early spring (March). For the remainder of the year (approximately 7-8 months), snowfall is uncommon or non-existent. As a result, for these non-winter months, the recorded snowfall value is naturally 0 mm, significantly increasing the frequency of zero values.
    
    * **Incomplete or Selective Data Reporting:**  As noted in the dataset's description, each station may collect only a subset of the variables, which could mean that not all stations consistently report snowfall data, especially if snowfall is infrequent in those regions. This selective reporting could bias the dataset toward more frequent 0 mm values, as stations that rarely or never observe snow may default to reporting zero.


```{r}
# Make two-panel plot showing the average max temperature in January & July in each station across years

# Load necessary libraries
library(ggplot2)
library(dplyr)
library(patchwork)


# Calculate the average max temperatures for January and July for each station
avg_tmax_jan_jul_station = 
  ny_noaa |>
  filter(month %in% c(1, 7)) |>
  group_by(id, year, month) |>
  summarise(avg_tmax = 
              mean(tmax, na.rm = TRUE)) |>
  ungroup()

# Create a faceted line plot by station for January and July
facet_line_plot =
  ggplot(avg_tmax_jan_jul_station, 
         aes(x = year, y = avg_tmax, 
             group = id, 
             color = factor(month))) +
  geom_line(alpha = 0.6) +
  scale_color_manual(values = c("blue", "red"), 
                     labels = c("January", "July")) +
  labs(title = "Average Max Temperature Trends by Station in January and July",
       x = "Year", 
       y = "Average Temperature (°C)", 
       color = "Month") +
  facet_wrap(~ month, 
             scales = "free_y", 
             labeller = labeller(month = 
                                   c('1' = "January", 
                                     '7' = "July"))) +
  theme_minimal() +
  theme(axis.text.x = 
          element_text(angle = 45, 
                       hjust = 1))

facet_line_plot


```


### Analysis of the Two-Panel Graph

**January Panel：**

* The January panel reveals that average maximum temperatures across stations remain relatively stable over time, with most stations showing consistent patterns without a long-term upward or downward trend. This stability indicates that winter temperatures have not experienced significant shifts in the observed years. However, some stations exhibit occasional deviations where temperatures either spike higher or dip lower than the rest, signaling potential outliers. These outliers could be due to isolated cold or warm events or data anomalies specific to certain stations.

**July Panel：**

* In contrast, the July panel displays a broader range of temperatures, with most stations fluctuating between 25 and 30°C. A slight upward trend is visible across several stations, hinting at a gradual warming pattern consistent with summer climate change impacts. Unlike January, there is more pronounced variability in July temperatures, with some stations showing extreme values either above 30°C or below 20°C. These variations may correspond to heatwaves or localized microclimatic effects, presenting potential outliers that require further investigation.

**Summary Comparison：**

* The January and July panels demonstrate distinct seasonal patterns. January temperatures remain stable with minimal long-term change, suggesting resilience in winter conditions, while July temperatures show more variability and a slight warming trend over time. The July panel also highlights a higher frequency of outliers, indicative of the greater susceptibility of summer temperatures to extreme events and localized climatic influences. This contrast emphasizes that summer months are more sensitive to temperature fluctuations and potential climate change effects than winter months.


```{r}
# Make two-panel plot showing tmax vs tmin for the full dataset & the distribution of snowfall values greater than 0 and less than 100 

# Load necessary library
library(ggridges)

# Prepare data for tmax vs tmin ridge plot
tmax_tmin_data = 
  ny_noaa |>
  filter(!is.na(tmax) & !is.na(tmin))

# Create a ridge plot for tmax grouped by rounded tmin values
tmax_tmin_ridge_plot = 
  ggplot(tmax_tmin_data, 
         aes(x = tmax, 
             y = factor(round(tmin, -1)), 
             fill = factor(round(tmin, -1)))) +
  geom_density_ridges(scale = 3, 
                      rel_min_height = 0.01) +
  labs(title = "Ridge Plot of Tmax Grouped by Rounded Tmin",
       x = "Maximum Temperature (°C)",
       y = "Rounded Minimum Temperature (°C)") +
  theme_minimal() +
  theme(legend.position = "none")

# Prepare data for the snowfall distribution plot
snowfall_data <- ny_noaa |>
  filter(snow > 0 & snow < 100) |>
  group_by(year) |>
  mutate(year = as.factor(year))

# Create a boxplot showing the distribution of snowfall values per year
snowfall_boxplot =
  ggplot(snowfall_data, 
         aes(x = year, y = snow)) +
  geom_boxplot(fill = "lightgreen", 
               alpha = 0.7) +
  labs(title = "Snowfall Distribution by Year (0 < snow < 100 mm)",
       x = "Year", 
       y = "Snowfall (mm)") +
  theme_minimal() +
  theme(axis.text.x = 
          element_text(angle = 90, 
                       hjust = 1))

# Combine the plots into a two-panel layout
combined_plot <- tmax_tmin_ridge_plot / snowfall_boxplot
combined_plot



```


### Analysis of the Two-Panel Graph

**Panel 1: Ridge Plot of tmax Grouped by Rounded tmin**

* The ridge plot illustrates the distribution of tmax values across different tmin categories. As tmin values increase, the distributions of tmax shift towards higher values, demonstrating a clear positive correlation between the two variables. The spread of the ridges indicates that maximum temperatures are more variable when minimum temperatures are low, but they become narrower and more consistent as tmin increases. The peaks in the ridges show the most common tmax values for each tmin category, confirming that higher minimum temperatures typically lead to higher and more stable maximum temperatures.

**Panel 2: Boxplot of Snowfall Distribution by Year**

* The boxplot shows the annual distribution of snowfall values between 0 and 100 mm, revealing the variability and consistency of snowfall over the years. While the median snowfall value remains generally stable, the interquartile ranges (IQR) vary, indicating differences in consistency from year to year. The presence of outliers highlights years with extreme snowfall events that deviate significantly from the norm, suggesting occasional severe weather occurrences that influence snowfall patterns.

**Summary**

* The ridge plot shows a consistent relationship between tmin and tmax, with temperatures becoming more stable as tmin rises. In contrast, the snowfall boxplot reveals annual variability, with stable medians but varying ranges and outliers indicating extreme events. Together, these panels effectively highlight the stability in temperature patterns and the variability in snowfall over time.



## Problem 2

### Part 1
```{r}

# 1. Load both datasets and clean column names
nhanes_covar = 
  read_csv("data/nhanes_covar.csv", 
           skip = 4) |>
  janitor::clean_names()

nhanes_accel = 
  read_csv("data/nhanes_accel.csv") |>
  janitor::clean_names()

# 2. Data explorations (check structure, summary, and missing values)
# summary(nhanes_covar)
# summary(nhanes_accel)
# colSums(is.na(nhanes_covar))
# colSums(is.na(nhanes_accel))

# 3. Data manipulations
nhanes_covar_df = 
  nhanes_covar |>
  filter(age >= 21) |>  # Exclude participants less than 21 years of age
  drop_na()  # Remove rows with missing demographic data

# 4. Merge datasets based on participant ID (SEQN)
nhanes_merged =
  nhanes_accel |>
  inner_join(nhanes_covar_df, 
             by = "seqn") |>
  select(all_of(colnames(nhanes_covar_df)),
         everything())

# 5. Convert appropriate columns to factors
nhanes_merged = 
  nhanes_merged |>
  mutate(
    sex = factor(sex, levels = c("1", "2"), 
                 labels = c("male", "female")),
    education = factor(education, 
                       levels = c("1", "2", "3"),
                       labels = c("Less than high school", 
                                  "High school equivalent", 
                                  "More than high school"),
                       ordered = TRUE)
  )

# 6. Check the structure and summary of the cleaned dataset
# summary(nhanes_merged)
```


### Part 2
```{r}
# 1. Produce a reader-friendly table for the number of men and women in each education category
education_sex_table =
  nhanes_merged |>
  group_by(education, sex) |>
  summarise(count = n()) |>
  pivot_wider(names_from = sex, 
              values_from = count, 
              values_fill = 0)

print(education_sex_table)

# 2. Create a visualization of age distributions for men and women in each education category
nhanes_merged |>
  ggplot(aes(x = age, fill = sex)) +
  geom_histogram(binwidth = 5, position = "dodge", color = "black", alpha = 0.7) +
  scale_fill_manual(values = c("#0073C2FF", "#EFC000FF")) +  # Change colors to be more distinct
  facet_wrap(~ education) +
  labs(
    title = "Age Distribution by Education Level and Sex",
    x = "Age",
    y = "Count",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_line(size = 0.25),
    legend.position = "bottom",
    strip.text = element_text(size = 12)
  )

```


**Table: Education-Sex Distribution**

* The table summarizes the number of participants by education level and sex, showing that the counts are relatively balanced between the two genders across all categories. In the "Less than high school" group, there are 27 males and 28 females. The "High school equivalent" category has a slightly higher number of males 35 compared to females 23. For the "More than high school" group, the count is higher for both genders, with 56 males and 59 females. This suggests that the sample is more concentrated in the higher education category, with a reasonably even distribution of participants by sex across all education levels.


**Plot: Age Distribution by Education Level and Sex**

* The plot displays the age distribution of participants across three education levels: Less than high school, High school equivalent, and More than high school. In the "More than high school" group, participants are mostly concentrated in the 20-40 year range, with a relatively even distribution across older ages, including participants beyond 60 years. The "Less than high school" group shows a more varied distribution, with noticeable counts in the 30-60 year range, but without a distinct peak. The "High school equivalent" category features a smaller and relatively uniform distribution across age groups, with a slight decline in participants above 60 years.

* Regarding gender representation, males (blue) and females (yellow) are generally evenly distributed across education levels. However, in the "More than high school" category, females slightly outnumber males in the 20-40 year age range. The "Less than high school" and "High school equivalent" categories display relatively balanced gender distributions, with no significant gender disparity evident in any age group.


**Summary**

* The analysis shows that participants with higher education levels (More than high school) tend to be younger, particularly clustered in the 20-40 years range, whereas participants with lower education levels (Less than high school) are more evenly spread across ages, with no pronounced peak. The gender distributions across education levels appear balanced, with a slight dominance of females in the 20-40 years range within the higher education group. This data suggests a relationship between education level and age distribution, while gender distribution remains relatively uniform across all education levels.


### Part 3
```{r}
# 1. Aggregate accelerometer data to create a total activity variable for each participant
nhanes_merged <- nhanes_merged %>%
  rowwise() %>%
  mutate(total_activity = sum(c_across(starts_with("min")), na.rm = TRUE))

# 2. Plot total activities against age, with separate panels for each education level
nhanes_merged %>%
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE, size = 1) +  # Use a smoother trend line for better representation
  facet_wrap(~ education) +
  scale_color_manual(values = c("#0073C2FF", "#EFC000FF")) +  # Use distinct colors for male and female
  labs(
    title = "Total Activity vs. Age by Education Level and Sex",
    x = "Age",
    y = "Total Activity",
    color = "Sex"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_line(size = 0.25),
    legend.position = "bottom",
    strip.text = element_text(size = 12)
  )


```


**Plot: Total Activity vs. Age by Education Level and Sex**

The plot illustrates the relationship between total activity and age, categorized by education level into three groups: “Less than high school,” “High school equivalent,” and “More than high school.” The data points are color-coded for sex, with blue representing males and yellow representing females. LOESS smoother curves are fitted to each dataset to highlight the trends.

* **Less than high school:** For both males and females, activity levels decrease as age increases. Males experience a significant peak in activity around the age of 50-60, followed by a sharp decline. Females start with higher activity levels than males before the age of 40, but after 40, males surpass females, with females showing a more gradual decrease.

* **High school equivalent:** Both males and females show an increasing trend in activity levels from around age 20 to 40, with females experiencing a more pronounced increase. After age 40, both genders exhibit a gradual decline, with females showing a steeper decrease. There is a slight rebound for females after age 60, but activity levels still decrease to match those of males by age 80. Males’ activity levels stabilize around age 60. Notably, females have higher activity levels than males for an extended period (from age 25 to 80).

* **More than high school:** The activity levels for both sexes are relatively stable, with only a slight decrease over the age range. Females have a slight peak in activity around age 60, which then declines. Males reach a slight peak around age 45 and then show a continuous decline. Notably, in this group, males consistently have lower activity levels than females.

**Summary:**

This visualization emphasizes the differences in physical activity trends based on educational attainment. Those with higher levels of education tend to have more stable and higher activity levels, while those with lower education levels experience a more significant decrease in activity with age. Additionally, the plot highlights the gender differences in activity levels across different education levels, with females often showing higher activity levels than males in certain age ranges.

### Part 4
```{r}
# 1. Create a 24-hour activity time course for each education level
# Aggregate the accelerometer data to create a time series for each minute across the day
nhanes_long <- nhanes_merged %>%
  pivot_longer(cols = starts_with("min"), names_to = "minute", values_to = "activity") %>%
  mutate(minute = as.numeric(str_remove(minute, "min")))

# 2. Plot the 24-hour activity time course
nhanes_long %>%
  ggplot(aes(x = minute, y = activity, color = sex)) +
  geom_line(stat = "summary", fun = "mean", alpha = 0.4, size = 0.8) +  # Plot mean activity for each minute with transparency for clarity
  geom_smooth(method = "loess", se = FALSE, linetype = "solid", size = 1.5) +  # Add a thicker smooth trend line for better visibility
  facet_wrap(~ education) +
  scale_color_manual(values = c("#0073C2FF", "#EFC000FF")) +  # Use distinct colors for male and female
  labs(
    title = "24-Hour Activity Time Course by Education Level and Sex",
    x = "Minute of the Day",
    y = "Mean Activity",
    color = "Sex"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_line(size = 0.25),
    legend.position = "bottom",
    strip.text = element_text(size = 12)
  )
```


**Plot: 24-Hour Activity Time Course by Education Level and Sex**

This plot delineates the average activity levels of individuals across a 24-hour period, categorized by education levels—"Less than high school," "High school equivalent," and "More than high school"—and by sex (male and female). The chart illustrates the activity patterns over the course of a day, with mean activity levels plotted against the minute of the day, and different colored lines representing different genders.

* **Less than High School:** Individuals in this category exhibit a peak in activity levels around midday, with males showing slightly higher average activity levels than females before 500 minutes; afterwards, the activity levels of both genders remain relatively consistent. There is a noticeable decline in activity levels for both sexes as the day progresses past noon.

* **High School Equivalent:** This group also demonstrates a midday peak in activity, with males having slightly higher average activity levels than females before 250 minutes. Although both genders show an increasing trend in average activity time afterwards, females surpass males around 125 minutes and maintain a slightly higher overall average activity level until 1000 minutes. After 1000 minutes, there is a significant decline in activity levels for both sexes, with females and males showing roughly equivalent average activity levels during the late evening.

* **More than High School:** Participants with higher education levels display higher overall activity levels throughout the day. Both males and females reach a peak in activity around noon, with the trend for both being similar to the "High School Equivalent" group but with a more pronounced increase. Females show a particularly sharp increase in activity levels, reaching a higher peak average activity level than the "High School Equivalent" group. In the afternoon, both males' and females' activity levels decline, with females showing a more significant decrease, but remaining slightly above males until 1250 minutes, after which the average activity levels of both genders tend to align.

**Summary:**
The plot underscores the influence of education level and sex on daily activity patterns. Individuals with higher education levels tend to maintain higher overall activity levels throughout the day. Males generally exhibit higher activity levels than females, especially in the less educated groups. The midday period sees the highest activity levels across all education levels, with a decline in the afternoon and evening hours. The differences between males and females are most pronounced in the higher education group, suggesting that lifestyle or occupational differences may play a role in shaping these patterns.[^44^]


## Problem 3

### Part 1
```{r}
# Load necessary packages
library(dplyr)
library(ggplot2)
library(readr)

# Load the data from four CSV files
jan_2020 = 
  read_csv("data/Jan 2020 Citi.csv") |>
  janitor::clean_names()

jan_2024 = 
  read_csv("data/Jan 2024 Citi.csv") |>
  janitor::clean_names()

july_2020 = 
  read_csv("data/July 2020 Citi.csv")|>
  janitor::clean_names()
  
july_2024 = 
  read_csv("data/July 2024 Citi.csv")|>
  janitor::clean_names()

# Add year and month columns to each dataset
jan_2020 = 
  jan_2020 |>
  mutate(year = 2020, month = 1)

jan_2024 = 
  jan_2024 |> 
  mutate(year = 2024, month = 1)

july_2020 = 
  july_2020 |>
  mutate(year = 2020, month = 7)

july_2024 = 
  july_2024 |>
  mutate(year = 2024, month = 7)

# Combine all datasets into one for analysis
combined_df = bind_rows(jan_2020, 
                        jan_2024, 
                        july_2020, 
                        july_2024)

# Convert variables to appropriate types & Drop rows with missing station names to ensure clean data
cleaned_df = 
  combined_df |>
  mutate(
    rideable_type = factor(rideable_type ,level = c("classic_bike", "electric_bike")),
    weekdays = factor(weekdays, levels = c("Sunday", 
                                           "Monday", 
                                           "Tuesday", 
                                           "Wednesday",
                                           "Thursday",
                                           "Friday",
                                           "Saturday")),
    member_casual = factor(member_casual, levels = c("casual", "member"))
  ) |>
  drop_na()


# Display summary of the dataset
summary(cleaned_df)
```

**Key Steps in Data Cleaning Process**

**1. Loading the data:**
* Four datasets—`jan_2020`, `jan_2024`, `july_2020`, and `july_2024`— were loaded using the `read_csv()` function. Column names were cleaned using `janitor::clean_names()` to standardize them. These datasets contain Citi Bike trip data from January and July in 2020 and 2024, enabling longitudinal and seasonal comparisons.

**2. Adding year and month columns:**
* Each dataset was enriched with `year` and `month` columns using the `mutate()` function. For example, `jan_2020` was assigned `year = 2020` and `month = 1`, and `july_2024` was assigned `year = 2024` and `month = 7`.

**3. Combining datasets:**
* The four datasets were merged into a single dataframe, `combined_df`, using the `bind_rows()` function, making the data easier to analyze across periods.

**4. Converting variables and filtering missing values:**
* Several variables were converted to factors for better handling:

  * `rideable_type`: Converted to a factor with levels `"classic_bike"` and `"electric_bike"`.
  * `weekdays`: Converted to an ordered factor with levels `"Sunday"` to `"Saturday"`.
  * `member_casua`l: Converted to a factor with levels `"casual"` and `"member"`.

* The `drop_na()` function was applied to remove rows where either `start_station_name` or `end_station_name` had missing values, ensuring data consistency.


**Data Descriptions**

* `ride_id (character)`:

  * Contains `r n_distinct(cleaned_df$ride_id)` unique identifiers, ensuring each trip is recorded as a distinct entry.


* `rideable_type (factor)`:

  * Bike types include `"classic_bike"` and `"electric_bike"`.
  * Counts:
    * Classic bike: `r sum(cleaned_df$rideable_type == "classic_bike")`
    * Electric bike: `r sum(cleaned_df$rideable_type == "electric_bike")`


* `weekdays (ordered factor)`:

  * Records the day of the week each trip occurred, with levels from `"Sunday"` to `"Saturday"`.


* `duration (numeric)`:

  * Represents the trip duration in minutes.
  * Summary statistics:
    * Minimum: `r min(cleaned_df$duration)` minutes
    * 1st Quartile: `r quantile(cleaned_df$duration, 0.25)` minutes
    * Median: `r median(cleaned_df$duration)` minutes
    * Mean: `r mean(cleaned_df$duration)` minutes
    *3rd Quartile: `r quantile(cleaned_df$duration, 0.75)` minutes
    *Maximum: `r max(cleaned_df$duration)` minutes


* `start_station_name` & `end_station_name (character)`:

  * Capture the station names where each trip began and ended, respectively.


* `member_casual (factor)`:

  * Differentiates between `"member"` and `"casual"` riders.
  * Counts:
    * Member: `r sum(cleaned_df$member_casual == "member")`
    * Casual: `r sum(cleaned_df$member_casual == "casual")`


* `year` & `month (numeric)`:

  * Record the year and month when each trip took place.
  * Unique years: `r unique(cleaned_df$year)`
  * Unique months: `r unique(cleaned_df$month)`


**Overall Insights**

* The dataset reflects consistent usage of the NYC Citi Bike system, with `r sum(cleaned_df$member_casual == "member")` rides by members and `r sum(cleaned_df$member_casual == "casual")` rides by casual users, indicating that members account for a majority of trips.

* The distribution of rides across weekdays shows peak utilization on Wednesdays, with `r sum(cleaned_df$weekdays == "Wednesday")` rides, highlighting a pattern of higher usage during workdays, which could inform operational decisions.

* Ride durations are generally short, with a median duration of `r median(cleaned_df$duration)` minutes and most rides falling within the range of `r min(cleaned_df$duration)` to `r quantile(cleaned_df$duration, 0.75)` minutes, typical for urban commutes.

* The dataset spans multiple years and seasons, offering valuable insights into temporal changes in bike usage and the potential to identify long-term trends in user behavior between 2020 and 2024.




### Part 2
```{r}
# Group data by year, month, and member type
grouped_rides = 
  cleaned_df |>
  group_by(year, month, member_casual) |>
  summarise(total_rides = n(), .groups = 'drop') |>
  pivot_wider(names_from = member_casual,
              values_from = total_rides,
              values_fill = 0)

# Display the grouped rides table
print(grouped_rides)
```



**Table: Summary of Total Rides by Year, Month, and Rider Type**

This table presents the total number of rides categorized by year, month, and user type (member or casual) for January and July in 2020 and 2024. The table contains `r nrow(grouped_rides)` rows, with each row representing the total rides for a specific year, month, and user type combination.

 * **January 2020:**

    * Casual users: `r grouped_rides$casual[1]` rides
    * Members: `r grouped_rides$member[1]` rides
    * Despite being a winter month, member rides significantly outnumbered casual rides, indicating sustained member engagement.

  * **July 2020:**

    * Casual users: `r grouped_rides$casual[2]` rides
    * Members: `r grouped_rides$member[2]` rides
    * There is a notable increase in both casual and member rides compared to January 2020, reflecting higher demand during summer.

  * **January 2024:**

    * Casual users: `r grouped_rides$casual[3]` rides
    * Members: `r grouped_rides$member[3]` rides
    * Member rides grew significantly from January 2020, while casual rides also saw an increase, indicating increased activity even in the winter months.

  * **July 2024:**

    * Casual users: `r grouped_rides$casual[4]` rides
    * Members: `r grouped_rides$member[4]` rides
    * Both casual and member rides surged in July 2024, with member rides experiencing particularly strong growth, indicating peak demand in summer.


**Observations**

* **Higher Usage in Summer:**

  * Across all years, July recorded more rides than January for both user types. For example, member rides increased from `r grouped_rides$member[1]` in January 2020 to `r grouped_rides$member[2]` in July 2020, and from `r grouped_rides$member[3]` in January 2024 to `r grouped_rides$member[4]` in July 2024, showing the impact of seasonality on bike usage.

* **Significant Growth in Member Activity:**

  * Member rides grew substantially from 2020 to 2024, with July 2024 recording `r grouped_rides$member[4]` rides compared to `r grouped_rides$member[2]` in July 2020. This suggests a rising preference for membership over time.

* **Seasonal Variation:**

  * Casual rides exhibit strong seasonal variation, with relatively low counts in January (`r grouped_rides$casual[1]` in 2020 and `r grouped_rides$casual[3]` in 2024) compared to July (`r grouped_rides$casual[2]` in 2020 and `r grouped_rides$casual[4]` in 2024). This trend indicates casual users are more likely to ride during favorable weather conditions.

* **Moderate Growth in Casual Rides:**

  * Although casual rides increased between 2020 and 2024, the growth rate was moderate compared to that of member rides. Casual rides in July grew from `r grouped_rides$casual[2]` in 2020 to `r grouped_rides$casual[4]` in 2024, but this growth is smaller in proportion to the surge in member rides during the same period.

In summary, the data reflects a consistent pattern of higher bike usage during summer across both years, with member users contributing the majority of rides. Membership usage has shown significant growth from 2020 to 2024, suggesting that more users are opting for long-term subscriptions over occasional rides.


### Part 3
```{r}
# Filter data for July 2024
july_2024_df <- 
  cleaned_df |>
  filter(year == 2024, month == 7)

# Find the top 5 most popular starting stations
top_stations_july_2024 <- 
  july_2024_df |>
  group_by(start_station_name) |>
  summarize(number_of_rides = n(), .groups = 'drop') |>
  arrange(desc(number_of_rides)) |>
  head(5)

# Display the top 5 most popular starting stations for July 2024
print(top_stations_july_2024)

```


**Comment on Table: Top 5 Most Popular Starting Stations in July 2024**

This table displays the five most popular starting stations for Citi Bike rides in July 2024. The top station is Pier 61 at Chelsea Piers, with a total of `r nrow(filter(july_2024_df, start_station_name == "Pier 61 at Chelsea Piers"))` rides. This is closely followed by University Pl & E 14 St with `r nrow(filter(july_2024_df, start_station_name == "University Pl & E 14 St"))` rides, and W 21 St & 6 Ave with `r nrow(filter(july_2024_df, start_station_name == "W 21 St & 6 Ave"))`. The fourth and fifth positions are held by West St & Chambers St and W 31 St & 7 Ave, with `r nrow(filter(july_2024_df, start_station_name == "West St & Chambers St"))` and `r nrow(filter(july_2024_df, start_station_name == "W 31 St & 7 Ave"))` rides, respectively.

**Key Observations and Insights**

* Pier 61 at Chelsea Piers ranks first with the highest ride count, potentially indicating heavy foot traffic or tourism near this location.

* The close counts across all five stations (ranging from `r min(top_stations_july_2024$n)` to `r max(top_stations_july_2024$n)` suggest balanced demand among the most popular stations.

* All five stations are located near central areas with residential, commercial, and recreational attractions, hinting at their popularity among commuters and tourists alike.

* The insights from this table are useful for optimizing bike availability and strategically locating docking stations in high-demand areas for summer months.

This analysis provides a clear understanding of ride patterns in July 2024, offering actionable insights into the busiest starting points for better service planning during peak usage periods.




### Part 4
```{r, warning=FALSE}

# Calculate median ride duration by day of the week, month, and year
median_duration_df = 
  cleaned_df |>
  group_by(year, month, weekdays) |>
  summarise(median_duration = median(duration, na.rm = TRUE), .groups = 'drop')

# Plot median ride duration for each day of the week, grouped by year and month
ggplot(median_duration_df, 
       aes(x = weekdays, 
           y = median_duration, 
           group = interaction(year, month), 
           color = factor(year), 
           linetype = factor(month))) +
  geom_line(size = 1) +
  labs(title = "Median Ride Duration by Day of the Week (Grouped by Year and Month)",
       x = "Day of the Week",
       y = "Median Ride Duration (minutes)",
       color = "Year",
       linetype = "Month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


**Plot: Median Ride Duration by Day of the Week (Grouped by Year and Month)**

This plot displays the median ride duration across different days of the week, grouped by year (2020 vs. 2024) and month (January and July). The plot uses solid lines for January and dashed lines for July to indicate the seasonal differences. It effectively shows how the duration of rides varies not only between the years but also across days and months.


**Key Observations and Insights**

* **1. Seasonal Differences:**

    * In January (solid lines), the median ride durations are consistently lower compared to July, particularly for 2020 (`r min(median_duration_df$median_duration)` to `r max(median_duration_df$median_duration)` minutes).

    * July (dashed lines) displays higher median durations, with 2020 reaching around 15+ minutes on weekends, while 2024 has a slightly lower but more consistent trend across days.

* **2. Trend across Days of the Week:**

    * Ride durations show an increase towards the weekend, with Saturdays and Sundays having the longest median durations, especially for 2020.

    * This suggests that users tend to take longer rides during weekends, likely for leisure or recreational purposes, while weekday rides are shorter.

* **3. Yearly Comparison:**

    * In 2020, the difference between weekdays and weekends is more pronounced, especially in July, with ride durations peaking on Sundays.

    * In 2024, the overall median ride durations are slightly lower across both months, showing a more uniform pattern throughout the week, possibly indicating increased short-distance commutes or a shift towards quicker trips.

* **4. Impact of Months:**

  * July shows the most noticeable spike in duration for 2020, particularly for weekend rides, indicating higher demand and longer leisure activities during summer.

  * January displays flatter lines for both years, reflecting shorter trips, possibly due to colder weather limiting longer rides.

* **5. Behavioral Patterns and Use Cases:**

    * The combination of year, month, and day trends illustrates a seasonal and behavioral shift, where rides are more utilitarian during the winter months but shift towards recreational use in the summer, particularly in 2020.

**Conclusion**

This plot offers important insights into ride behavior over time, highlighting the effects of seasonality and day of the week on ride durations. Such insights are valuable for Citi Bike’s operational planning, allowing them to adjust bike availability and maintenance schedules based on anticipated demand spikes during weekends and summer months.



### Part 5
```{r}
# Filter the dataset for the year 2024
data_2024 <- cleaned_df %>%
  filter(year == 2024)

# Create a violin plot for ride duration by month, membership status, and bike type
ride_duration_violin_plot_2024 <- ggplot(data_2024, aes(x = factor(month), y = duration, fill = member_casual)) +
  geom_violin(trim = FALSE, alpha = 0.6) +  # Violin plot for distribution
  geom_point(stat = "summary", fun = "mean", size = 4, aes(fill = member_casual), color = "black", shape = 21, show.legend = TRUE) + # Mean points
  facet_wrap(~ rideable_type) +  # Separate panels for bike types
  labs(title = "Impact of Month, Membership Status, and Bike Type on Ride Duration (2024)",
       x = "Month",
       y = "Ride Duration (minutes)",
       fill = "Membership Status") +
  theme_minimal() +
  scale_x_discrete(labels = c("1" = "January", "7" = "July")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  # Make axis labels larger for better readability
        axis.text.y = element_text(size = 12),  # Larger y-axis labels
        axis.title = element_text(size = 14),  # Larger axis titles
        plot.title = element_text(size = 16, face = "bold"),  # Larger plot title
        legend.position = "top",
        legend.title = element_text(size = 14),  # Larger legend title
        legend.text = element_text(size = 12)) +  # Larger legend text
  coord_cartesian(ylim = c(0, 60)) +  # Set y-axis limits to zoom in on data
  geom_text(stat = "summary", fun = "mean", aes(label = round(..y.., 1)), vjust = -1.5, size = 4)  # Annotate mean values

# Print the plot
print(ride_duration_violin_plot_2024)

```


**Plot: Distribution of Ride Duration by Month, Membership Status, and Bike Type for 2024**

This plot visualizes the distribution of Citi Bike ride durations across two months in 2024: January and July. The ride durations are represented with violin plots, segmented by membership status into casual and member users, and further separated by bike type (classic vs electric). The y-axis indicates ride duration in minutes, and the x-axis differentiates the months. Mean ride durations are also highlighted as points within each violin plot.

**Key Observations and Insights:**

* **1. Comparison between Casual and Member Users:**

    * In both January and July, casual riders exhibit longer ride durations compared to member riders. For example, in July, casual riders have a mean duration of 20.6 minutes for classic bikes, while member riders have a mean of 10.8 minutes.

    * This pattern suggests that casual users, who may be using the bikes more for leisure or recreation, tend to take longer rides, while members, who are likely using the bikes for regular commuting, show shorter, more consistent ride durations.

* **2. Differences by Month and Season:**

    * The median ride duration is higher for both user types in July compared to January, suggesting increased activity in summer. This trend aligns with higher outdoor activity levels in warmer weather, which particularly impacts casual riders.

    * For both classic and electric bikes, casual users in July have longer median ride durations compared to January, highlighting the seasonal nature of their usage.

* **3. Impact of Bike Type:**

    * The availability of electric bikes shows a more balanced ride duration between casual and member users. Electric bikes are used for relatively shorter rides compared to classic bikes, particularly for casual users.

    * The mean ride durations for electric bikes in both months are lower compared to classic bikes, suggesting that the convenience of electric bikes may be leading to shorter but more frequent trips.

* **4. Distribution Spread:**

    * The violin plots indicate that casual users have a wider spread of ride durations compared to members, especially for classic bikes. This suggests greater variability in ride lengths for casual users, likely reflecting different purposes such as leisure versus transportation.

    * Member users demonstrate a more consistent pattern, with tighter distributions for ride durations across both bike types, reflecting structured commuting habits.

**Conclusion**

The violin plots reveal interesting insights into how ride duration varies with month, membership status, and bike type. Casual riders generally have longer ride durations, with increased usage during the summer, particularly for classic bikes. Members tend to use bikes more consistently across seasons, likely for commuting purposes, and exhibit shorter, less variable ride durations. The introduction of electric bikes appears to facilitate shorter trips for both user groups, emphasizing their potential for quick, convenient commutes.